generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Stage {
  Prospecting
  Qualification
  ProposalPriceQuote @map("Proposal/Price Quote")
  NegotiationReview  @map("Negotiation/Review")
  ClosedWon          @map("Closed Won")
  ClosedLost         @map("Closed Lost")
}

enum AccountType {
  Enterprise
  MidMarket @map("Mid-Market")
  SMB
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  OPEN
  OVERDUE
  COMPLETED
}

enum ActivityType {
  EMAIL
  CALL
  TASK
  NOTE
  MEETING
}

enum InvoiceStatus {
  PAID
  SENT
  OVERDUE
  DRAFT
}

enum LeadStatus {
  NEW
  WORKING
  NURTURING
  QUALIFIED
  DISQUALIFIED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
}

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  CANCELLED
}

enum WorkflowTriggerType {
  OPPORTUNITY_STAGE_CHANGED
  TASK_OVERDUE
  INACTIVITY
}

enum WorkflowActionType {
  CREATE_TASK
  SEND_EMAIL
  CREATE_INVOICE
  INVOKE_AI
}

enum AIInsightType {
  SUMMARY
  NEXT_STEP
  RISK
  EMAIL_DRAFT
}

enum NotificationType {
  TASK
  OPPORTUNITY
  INVOICE
  WORKFLOW
}

enum NotificationStatus {
  UNREAD
  READ
}

model Account {
  id         Int           @id @default(autoincrement())
  name       String       @unique
  industry   String?
  type       AccountType   @default(Enterprise)
  revenue    Int?
  employees  Int?
  owner      String?
  phone      String?
  website    String?
  location   String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  contacts       Contact[]
  opportunities  Opportunity[]
  invoices       Invoice[]
  tasks          Task[]
  leads          Lead[]
  quotes         Quote[]
  contracts      Contract[]
  notifications  Notification[]
}

model Contact {
  id         Int       @id @default(autoincrement())
  name       String
  title      String?
  email      String       @unique
  phone      String?
  owner      String?
  lastContact DateTime? @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  account   Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId Int

  opportunities Opportunity[]
}

model Opportunity {
  id           Int       @id @default(autoincrement())
  name         String     @unique
  amount       Int
  closeDate    DateTime
  probability  Int       @default(0)
  owner        String
  stage        Stage     @default(Prospecting)
  email        String?
  phone        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId Int

  contact   Contact? @relation(fields: [contactId], references: [id])
  contactId Int?

  activities Activity[]
  tasks      Task[]
  documents  Document[]
  quotes     Quote[]
  contracts  Contract[]
  insights   AIInsight[]

  lead     Lead?    @relation("LeadOpportunity", fields: [leadId], references: [id])
  leadId   Int?     @unique
}

model Activity {
  id            Int          @id @default(autoincrement())
  type          ActivityType
  subject       String
  description   String?
  performedBy   String
  performedAt   DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId Int?
}

model Document {
  id          Int       @id @default(autoincrement())
  name        String
  type        String
  size        String
  uploadedBy  String
  uploadedAt  DateTime  @default(now())

  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId Int?
}

model Task {
  id            Int        @id @default(autoincrement())
  title         String
  dueDate       DateTime
  priority      TaskPriority @default(MEDIUM)
  status        TaskStatus   @default(OPEN)
  assignedTo    String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  account   Account?    @relation(fields: [accountId], references: [id])
  accountId Int?

  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  opportunityId Int?

  workflowRule   WorkflowRule? @relation(fields: [workflowRuleId], references: [id], onDelete: SetNull)
  workflowRuleId Int?

  insights AIInsight[]
}

model Invoice {
  id         String      @id
  amount     Int
  status     InvoiceStatus @default(DRAFT)
  issueDate  DateTime
  dueDate    DateTime
  paidDate   DateTime?
  notes      String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId Int

  items     InvoiceItem[]
}

model InvoiceItem {
  id          Int     @id @default(autoincrement())
  description String
  quantity    Int     @default(1)
  rate        Int

  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String
}

model Lead {
  id          Int        @id @default(autoincrement())
  name        String
  company     String?
  email       String?
  phone       String?
  source      String?
  status      LeadStatus @default(NEW)
  owner       String?
  score       Int?       @default(0)
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  account   Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  accountId Int?

  opportunity Opportunity? @relation("LeadOpportunity")
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  sku         String?  @unique
  description String?
  unitPrice   Int
  currency    String   @default("PHP")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quoteLines QuoteLine[]
}

model Quote {
  id         Int         @id @default(autoincrement())
  number     String      @unique
  status     QuoteStatus @default(DRAFT)
  total      Int         @default(0)
  currency   String      @default("PHP")
  issuedAt   DateTime    @default(now())
  expiresAt  DateTime?
  notes      String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId   Int
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  opportunityId Int?

  lines QuoteLine[]
}

model QuoteLine {
  id          Int      @id @default(autoincrement())
  description String
  quantity    Int      @default(1)
  unitPrice   Int
  discount    Int      @default(0)

  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteId Int

  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId Int?
}

model Contract {
  id             Int            @id @default(autoincrement())
  contractNumber String         @unique
  status         ContractStatus @default(DRAFT)
  startDate      DateTime
  endDate        DateTime?
  value          Int            @default(0)
  terms          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId   Int
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  opportunityId Int?
}

model WorkflowRule {
  id           Int                 @id @default(autoincrement())
  name         String
  description  String?
  triggerType  WorkflowTriggerType
  triggerConfig Json?
  conditionConfig Json?
  isActive     Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  actions WorkflowAction[]
  tasks   Task[]
}

model WorkflowAction {
  id         Int                @id @default(autoincrement())
  type       WorkflowActionType
  actionConfig Json?
  createdAt  DateTime           @default(now())

  rule   WorkflowRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  ruleId Int
}

model AIInsight {
  id          Int          @id @default(autoincrement())
  type        AIInsightType
  summary     String
  confidence  Int?         @default(0)
  metadata    Json?
  createdAt   DateTime     @default(now())

  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  opportunityId Int?

  task   Task? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  taskId Int?
}

model Notification {
  id          Int               @id @default(autoincrement())
  type        NotificationType  @default(TASK)
  status      NotificationStatus @default(UNREAD)
  title       String
  body        String
  link        String?
  recipient   String
  createdAt   DateTime          @default(now())
  readAt      DateTime?

  account   Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  accountId Int?
}

model Team {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members UserTeam[]
}

model UserTeam {
  id        Int      @id @default(autoincrement())
  userEmail String
  role      String?

  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId Int
}
